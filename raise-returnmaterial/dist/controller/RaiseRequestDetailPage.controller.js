sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment","sap/ui/model/Sorter","sap/ui/Device","sap/ui/core/routing/History","sap/m/ColumnListItem","sap/m/Input","sap/base/util/deepExtend","sap/ui/export/Spreadsheet","sap/m/MessageToast","sap/m/MessageBox","sap/m/ObjectIdentifier","sap/m/Text","sap/m/Button","sap/m/Dialog","../utils/formatter"],function(e,t,i,n,o,s,a,r,l,d,c,g,h,m,u,p,f,v,w){"use strict";return e.extend("com.agel.mmts.raisereturnmaterial.controller.RaiseRequestDetailPage",{formatter:w,onInit:function(){this.getView().addEventDelegate({onAfterShow:this.onBeforeShow},this);var e=new t({busy:false,delay:0,boqSelection:null,csvFile:"file"});this.setModel(e,"objectViewModel");this._initializeCreationModels();this._mViewSettingsDialogs={};this.oRouter=this.getRouter();this.oRouter.getRoute("RouteReturnDetailPage").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:function(e){var t=e.getParameter("arguments").POId;this._bindView("/PurchaseOrderSet"+t)},_initializeCreationModels:function(){var e=new t({parent_line_item_id:null,description:null,po_number:null,material_code:null,qty:null,purchase_order_ID:null});this.getView().setModel(e,"parentItemCreationModel");var e=new t({parent_line_item_ID:null,child_line_item_id:(Math.floor(Math.random()*(7777777777-7e9+1))+7e9).toString(),description:null,material_code:null,qty:null,comments:"Additional child items comments",uom:null});this.getView().setModel(e,"childItemCreationModel")},_bindView:function(e){var t=this.getViewModel("objectViewModel");var i=this;this.getView().bindElement({path:e,events:{dataRequested:function(){t.setProperty("/busy",true)},dataReceived:function(){t.setProperty("/busy",false)}}})},handleToAllVendorsBreadcrumPress:function(e){this.getRouter().navTo("RouteLandingPage")},handleToAllPOBreadcrumPress:function(e){history.go(-1)},onParentItemsTableUpdateFinished:function(e){},onChildTableUpdateStarted:function(e){e.getSource().setBusy(true)},onChildItemsTableUpdateFinished:function(e){e.getSource().setBusy(false)},onViewChildItemPress:function(e){var t=e.getSource();var i=this;var n=e.getSource().getParent().getBindingContextPath();i.handleChildItemsDialogOpen(n)},handleChildItemsDialogOpen:function(e){var t={};t.controller=this;t.view=this.getView();t.sParentItemPath=e;if(!this.pDialog){this.pDialog=o.load({id:t.view.getId(),name:"com.agel.mmts.vendorPersona.view.fragments.PODetails.ChildItemsDialog",controller:t.controller}).then(function(e){t.view.addDependent(e);e.bindElement({path:t.sParentItemPath,parameters:{expand:"child_line_items"}});return e})}this.pDialog.then(function(e){t.view.addDependent(e);e.bindElement({path:t.sParentItemPath,parameters:{expand:"child_line_items"}});e.open()})},onViewChildDialogClose:function(e){this.pDialog.then(function(e){e.close()})},onConfirmPO:function(){var e=this.getView().getBindingContext().getObject().PONumber;m.confirm("Do you want to confirm Purchase Order "+e+"?",{styleClass:"sapUiResponsivePadding--header sapUiResponsivePadding--content sapUiResponsivePadding--footer",actions:[m.Action.OK,m.Action.CANCEL],emphasizedAction:m.Action.OK,onClose:function(e){if(e=="OK"){this.confirmPO()}}.bind(this)})},confirmPO:function(e){var t=this.getView().getBindingContext().getPath();var i=this.getView().getBindingContext().getObject().PONumber;var n={Status:"CONFIRMED",ConfirmedDate:new Date};this.getComponentModel().update(t,n,{success:function(e,t){sap.m.MessageBox.success("Purchase Order "+i+" has been confirmed! Please raise the inspection call through SIMS portal.");this.getComponentModel().refresh()}.bind(this),error:function(e){sap.m.MessageBox.error(JSON.stringify(e))}})},onPackingListPress:function(e){this._showPackingDetails(e.getSource())},onCreateChildItemPress:function(e){if(!this._oCreateParentItemDialog){this._oCreateDialog=sap.ui.xmlfragment("com.agel.mmts.vendorPersona.view.fragments.PODetails.CreateChildItem",this);this.getView().addDependent(this._oCreateDialog)}this._oCreateDialog.open()},onSaveChildLineItemPress:function(e){var t=this;var i=this.getView().byId("idChildItemsTable"),n=i.getBinding("items"),o=this.getViewModel("childItemCreationModel").getData(),s=i.getBindingContext().getPath(),a=n.create({parent_line_item_ID:s.slice("/ParentLineItems(".length,s.length-1),child_line_item_id:o.child_line_item_id,description:o.description,material_code:o.material_code,qty:parseInt(o.qty),comments:o.comments,uom:o.uom});console.log(a);a.created().then(function(){sap.m.MessageBox.success("New entry created!")}.bind(a,t),function(e){sap.m.MessageBox.success("Error Creating Entries!!")}.bind(a));this.closeDialog()},onChildItemsSavePress:function(e){var t=function(e){}.bind(this);var i=function(e){sap.m.MessageBox.alert(e.toString())}.bind(this);this.getView().getModel().submitBatch("childLineItemGroup").then(t,i)},onSearch:function(e){var t=[];var o=this.getView().byId("idSearchField").getValue();if(o){t.push(new i("material_code",n.Contains,o));t.push(new i("description",n.Contains,o));t.push(new i("uom",n.Contains,o))}var s=new i({filters:t,and:false});var a=this.getView().byId("idParentLineItemsTable").getBinding("items");a.filter(s)},onSearchChildItem:function(e){var t=[];var o=this.getView().byId("idSearchField").getValue();if(o){t.push(new i("description",n.Contains,o));t.push(new i("uom",n.Contains,o))}var s=new i({filters:t,and:false});var a=this.getView().byId("idChildItemsTable").getBinding("items");a.filter(s)},onSearchInspectionItem:function(e){var t=[];var o=this.getView().byId("idSearchFieldInspectionID").getValue();if(o){t.push(new i("inspection_call_id",n.Contains,o))}var s=new i({filters:t,and:false});var a=this.getView().byId("idInspectionTable").getBinding("items");a.filter(s)},_showPackingDetails:function(e){console.log(e.getBindingContext().getObject().ID)},getViewSettingsDialog:function(e){var t=this._mViewSettingsDialogs[e];if(!t){t=o.load({id:this.getView().getId(),name:e,controller:this}).then(function(e){if(a.system.desktop){e.addStyleClass("sapUiSizeCompact")}return e});this._mViewSettingsDialogs[e]=t}return t},onManageBOQItemPress:function(e){var t=this.getView().getBindingContext().getObject().PONumber;var i=e.getParameters().getParameter("bindingParams");i.parameters["expand"]="BOQGroups";i.parameters["navigation"]={ParentLineItemSet:"BOQGroups"};i.parameters["treeAnnotationProperties"]={hierarchyLevelFor:"HierarchyLevel",hierarchyNodeFor:"ID",hierarchyParentNodeFor:"ParentNodeID"};i.filters.push(new sap.ui.model.Filter("PONumber",sap.ui.model.FilterOperator.EQ,t))},onBeforeShow:function(e){this.getView().getContent()[0].getSections()[1].rerender();this.getView().getContent()[0].getSections()[3].rerender();this.getView().getContent()[0].getSections()[4].rerender();this.getView().getContent()[0].getSections()[2].rerender()},onSendForApprovalPress:function(e){var i=e.mParameters.getSource().getBindingContext().getObject();var n=this.getView().getBindingContext().getObject().ID;var o=new t({oBOQGroupSelected:i,sPurchaseOrderId:n});this.getView().setModel(o,"sendForApprovalModel");this._openConfirmationDialog()},_openConfirmationDialog:function(){this.oApproveDialog=new v({type:sap.m.DialogType.Message,title:"Confirm",content:new p({text:"Do you want to send the "+this.getViewModel("sendForApprovalModel").getProperty("/oBOQGroupSelected").Name+" group for TC approval?"}),beginButton:new f({type:sap.m.ButtonType.Emphasized,text:"Send",press:function(){this.sendForApproval();this.oApproveDialog.close()}.bind(this)}),endButton:new f({text:"Cancel",press:function(){this.oApproveDialog.close()}.bind(this)})});this.oApproveDialog.open()},sendForApproval:function(e){this.oApproveDialog.close();var t=this.getViewModel("sendForApprovalModel");var i={PurchaseOrderId:t.getProperty("/sPurchaseOrderId"),BOQGroupId:t.getProperty("/oBOQGroupSelected").ID};this.getComponentModel().create("/ParentLineItemTCApprovalListSet",i,{success:function(e,t){if(e.Success)sap.m.MessageBox.success(e.Message);else sap.m.MessageBox.error(e.Message);this.getView().getContent()[0].getSections()[2].rerender()}.bind(this),error:function(e){sap.m.MessageBox.success(JSON.stringify(e))}})},onViewBOQItemPress:function(e){var t=e.mParameters.getSource().getBindingContext().getPath();var i=e.mParameters.getSource().getBindingContext().getObject().Name+" Items";var n={};n.controller=this;n.view=this.getView();n.sBOQItemPath=t;n.title=i;if(!this.boqDialog){this.boqDialog=o.load({id:n.view.getId(),name:"com.agel.mmts.vendorPersona.view.fragments.PODetails.ViewBOQItems",controller:n.controller}).then(function(e){n.view.addDependent(e);e.bindElement({path:n.sBOQItemPath});e.setTitle(n.title);if(a.system.desktop){e.addStyleClass("sapUiSizeCompact")}return e})}this.boqDialog.then(function(e){n.view.addDependent(e);e.bindElement({path:n.sBOQItemPath});e.open()})},onViewBOQItemDialogClose:function(e){this.boqDialog.then(function(e){e.close()})}})});